<?php
//ini_set('session.save_path', '/tmp');
//session_start();

// --- 🌐 Aiven & Render MySQL Connection ---
$host = getenv('DB_HOST');
$port = getenv('DB_PORT');
$user = getenv('DB_USER');
$pass = getenv('DB_PASS');
$db   = getenv('DB_NAME');
$ca_content = getenv('DB_CA_CERT');

// 🔒 เขียนไฟล์ CA ชั่วคราว
if (!$ca_content) {
    die("❌ Missing DB_CA_CERT environment variable");
}

$tmp_ca = tempnam(sys_get_temp_dir(), 'ca_');
file_put_contents($tmp_ca, $ca_content);

$conn = mysqli_init();
if (!$conn) {
    die("❌ Error: mysqli_init failed");
}

// ✅ ตั้งค่า SSL โดยใช้ CA จาก environment
mysqli_ssl_set($conn, NULL, NULL, $tmp_ca, NULL, NULL);

if (
    !mysqli_real_connect(
        $conn,
        $host,
        $user,
        $pass,
        $db,
        (int)$port,
        NULL,
        MYSQLI_CLIENT_SSL
    )
) {
    die("❌ Connection Failed: " . mysqli_connect_error());
}

// ‼️ [แก้ไขแล้ว] ‼️
// ลบบรรทัด 'echo "✅ Connected..."' ทิ้ง
// เพราะมันทำให้เกิด Error "headers already sent"
// และขัดขวางการ Login ครับ

?>
